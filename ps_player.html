<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Image Song Player with List</title>
  <style>
    :root {
      --bg-color: #444444;
      --btn-bg: #222;
      --btn-hover: #444;
      --accent-color: #0a0;
      --text-color: #fff;
    }

    html {
      font-size: 1.6vmin;
      box-sizing: border-box;
    }

    *,
    *:before,
    *:after {
      box-sizing: inherit;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: system-ui, sans-serif;
      margin: 0;
      height: 100vh;
      
      overflow: hidden;
    }

    #searchBox {
      padding: 1rem;
      /* border: 0.125rem solid var(--text-color); */
      background: var(--btn-bg);
      color: var(--text-color);
      font-size: 3rem;
      width: 100%;
    }

    ul#musicList {
      padding: 0;
      margin: 0;
      list-style: none;
      
    }

    ul#musicList li {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 150px;
      margin: 1rem auto;
      cursor: pointer;
      border-radius: 1rem;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    ul#musicList li::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("ps_player_images/ps_list_design_01.webp") center/contain no-repeat;
      z-index: 3;
      pointer-events: none;
    }

    ul#musicList li img {
      position: absolute;
      top: 73px;
      left: 73px;
      width: 181px;
      height: 181px;
      object-fit: cover;
      border-radius: 0.5rem;
      z-index: 1;
      transform: translate(-50%, -50%);
    }

    ul#musicList li span {
      position: absolute;
      top: 60px;
      left: 190px;
      right: 20px;
      z-index: 4;
      color: #2e2e2e;
      font-size: 1.5rem;
      font-weight: 600;
      font-family: Consolas, 'Courier New', monospace;
    }

    ul#musicList li:hover {
      transform: scale(1.03);
    }

    ul#musicList li.active {
      transform: scale(1.15);
    }

    .container {
      position: relative;
      width: 100%;
      max-width: 45.5rem;
      aspect-ratio: 1 / 1;
      /* border-radius: 1.25rem; */
      overflow: hidden;
      margin-bottom: 1.5rem;
      transform-origin: center center;
      margin-left: auto;
      margin-right: auto;
    }

    .layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 1.25rem;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
      transition: transform 0.6s ease-in-out, opacity 0.4s ease;
    }

    #layer1 {
      background-image: url('ps_player_images/ps_front_cover.webp');
      z-index: 5;
    }

    #layer2 {
      background-image: url('ps_player_images/ps_disk_cover.webp');
      z-index: 4;
    }

    #disk {
      background-image: url('ps_player_images/ps_default_disk_00.webp');
      z-index: 3;
    }

    #layer4 {
      background-image: url('ps_player_images/ps_empty_disk.webp');
      z-index: 2;
    }

    #layer5 {
      background-image: url('ps_player_images/ps_disk_back.webp');
      z-index: 1;
    }

    .controls,
    .volume-controls {
      display: flex;
      flex-wrap: wrap;
      /* gap: 1rem; */
      /* justify-content: center; */
      /* align-items: center; */
      /* margin-bottom: 1rem; */
    }
    
    /* This rule applies to the original controls div, not the new grid wrapper */
    div.controls {
        /* margin-bottom: 1rem; */
    }
    /* This rule applies to the volume controls div */
    .volume-controls {
        margin-bottom: 0; /* Remove double margin */
    }

    button {
      background: var(--btn-bg);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
      width: 3.75rem;
      height: 3.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.375rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.3);
    }

    button:hover {
      background: var(--btn-hover);
      transform: scale(1.1);
      box-shadow: 0 0.375rem 0.75rem rgba(0, 0, 0, 0.4);
    }

    button:active {
      transform: scale(1.0);
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
    }

    button img {
      width: 60%;
      height: 60%;
      object-fit: contain;
      pointer-events: none;
    }

    .volume-controls input[type="range"] {
      width: 10rem;
      accent-color: var(--accent-color);
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .rotating {
      animation: spin 6s linear infinite;
    }

    .slide-down {
      transform: translateY(120%);
      opacity: 0;
    }

    .slide-up {
      transform: translateY(-120%);
      opacity: 0;
    }

    .slide-reset {
      transform: translateY(0);
      opacity: 1;
    }

    #shuffleBtn.active {
      background: var(--accent-color);
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3), inset 0 0 0.625rem rgba(0, 0, 0, 0.5);
    }

    /* --- NEW GRID LAYOUT --- */
    .grid {
      display: grid;
      width: 100vw;
      height: 100vh;
      gap: 1rem; 
      padding: 1rem;
      box-sizing: border-box;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: 1fr 2fr 2fr 1fr;
    }

    /* Layout positions */
    .player {
      grid-column: 1 / 2;
      grid-row: 1 / 4;
      /* Added styles to center player and allow scroll if needed */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: auto;
      min-width: 0;
      min-height: 0;
      border: 5px solid transparent;
      border-radius: 15px;
      background: linear-gradient(to top, #7e7e7e, #2e2e2e) padding-box,
                  linear-gradient(to bottom, #7e7e7e, #2e2e2e) border-box;
      

    }

    /* This is the new grid wrapper for BOTH control sets */
    .controls {
      grid-column: 1 / 2;
      grid-row: 4 / 5;
      /* Added styles to stack/center the control divs */
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      min-width: 0;
      border: 5px solid transparent;
      border-radius: 15px;
      background: linear-gradient(to top, #7e7e7e, #2e2e2e) padding-box,
                  linear-gradient(to bottom, #7e7e7e, #2e2e2e) border-box;


    }

    .search_box {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      /* Added styles to center search box */
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
      border: 5px solid transparent;
      border-radius: 15px;
      /* background: linear-gradient(to top, #171717, #171717) padding-box,
                  linear-gradient(to bottom, #7e7e7e, #2e2e2e) border-box; */

    }

    .list {
      grid-column: 2 / 3;
      grid-row: 2 / 5;
      /* Added styles from old .list-container */
      overflow-y: auto;
      min-width: 0;
      min-height: 0;
      border: 5px solid transparent;
      border-radius: 15px;
      background: linear-gradient(to top, #7e7e7e, #2e2e2e) padding-box,
                  linear-gradient(to bottom, #7e7e7e, #2e2e2e) border-box;

    }
    /* --- END NEW GRID LAYOUT --- */


    @media (max-width: 900px) {
      .grid { /* UPDATED from body */
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto 1fr; /* UPDATED for 4 items */
        height: 100vh;
        padding: 1rem;
        gap: 1rem;
      }
      
      /* ADDED mobile grid layout */
      .player {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
      }
      .controls {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      .search_box {
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
      .list {
        grid-column: 1 / 2;
        grid-row: 4 / 5;
      }
      /* END ADDED */

      html {
        font-size: 2vmin;
      }

      .container {
        margin-bottom: 1rem;
      }
    }
  </style>
</head>

<body class="grid">

  <div class="player">
    <div class="container">
      <div id="layer1" class="layer"></div>
      <div id="layer2" class="layer"></div>
      <div id="disk" class="layer"></div>
      <div id="layer4" class="layer"></div>
      <div id="layer5" class="layer"></div>
    </div>
  </div>

  <div class="controls">
    <div class="controls"> <button id="shuffleBtn" title="Shuffle"><img src="ps_player_images/icons/shuffle.png" alt="Shuffle"></button>
      <button id="prevBtn" title="Previous"><img src="ps_player_images/icons/prev.png" alt="Previous"></button>
      <button id="playPauseBtn" title="Play/Pause"><img src="ps_player_images/icons/play.png" alt="Play" id="playPauseIcon"></button>
      <button id="nextBtn" title="Next"><img src="ps_player_images/icons/next.png" alt="Next"></button>
      <button id="muteBtn" title="Mute"><img src="ps_player_images/icons/volume_up.png" alt="Mute" id="muteIcon"></button>
    </div>

    <div class="volume-controls">
      <button id="volDownBtn" title="Volume Down"><img src="ps_player_images/icons/volume_down.png" alt="Volume Down"></button>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
      <button id="volUpBtn" title="Volume Up"><img src="ps_player_images/icons/volume_up.png" alt="Volume Up"></button>
    </div>
  </div>

  <div class="search_box">
    <input type="text" id="searchBox" placeholder="Search...">
  </div>

  <div class="list">
    <ul id="musicList"></ul>
  </div>

  <audio id="audio"></audio>

  <script>
    const audio = document.getElementById("audio");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const playPauseIcon = document.getElementById("playPauseIcon");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const muteBtn = document.getElementById("muteBtn");
    const muteIcon = document.getElementById("muteIcon");
    const volumeSlider = document.getElementById("volumeSlider");
    const volUpBtn = document.getElementById("volUpBtn");
    const volDownBtn = document.getElementById("volDownBtn");
    const layer2 = document.getElementById("layer2");
    const layer4 = document.getElementById("layer4");
    const disk = document.getElementById("disk");
    const musicListElement = document.getElementById("musicList");
    const searchBox = document.getElementById("searchBox");
    const DEFAULT_DISK_IMAGE = "ps_player_images/ps_default_disk_00.webp";
    let playlist = [];
    let currentSong = 0;
    let isPlaying = false;
    let isShuffling = false;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

    async function fetchPlaylistFromFolder() {
      try {
        const res = await fetch("/music/");
        const text = await res.text();
        const matches = [...text.matchAll(/href="([^"]+\.(mp3|ogg|wav))"/gi)];
        const files = matches.map(m => decodeURIComponent(m[1])).filter(f => !f.startsWith("cover/"));
        playlist = files.map(filename => {
          const base = filename.replace(/\.[^/.]+$/, "");
          return { src: `music/${filename}`, diskImage: `music/cover/${base}.webp`, name: base };
        });
        if (!playlist.length) return console.warn("No songs found.");
        buildMusicList();
        await loadSong(currentSong);
      } catch (err) { console.error("Could not load music folder:", err); }
    }

    function buildMusicList() {
      musicListElement.innerHTML = "";
      playlist.forEach((song, index) => {
        const li = document.createElement("li");
        const img = document.createElement("img");
        img.src = song.diskImage;
        img.onerror = () => { img.src = DEFAULT_DISK_IMAGE };
        const span = document.createElement("span");
        span.textContent = song.name.replace(/_/g, " ");
        li.appendChild(img);
        li.appendChild(span);
        li.addEventListener("click", () => {
          currentSong = index;
          transitionToNextSong(currentSong);
        });
        musicListElement.appendChild(li);
      });
      highlightCurrentSong();
    }

    function highlightCurrentSong() {
      Array.from(musicListElement.children).forEach((li, idx) => {
        li.classList.toggle("active", idx === currentSong);
      });
    }

    function filterMusicList(query) {
      Array.from(musicListElement.children).forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(query.toLowerCase()) ? "" : "none";
      });
    }

    function setDiskImage(imageUrl) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => { disk.style.backgroundImage = `url('${imageUrl}')`; resolve(); };
        img.onerror = () => { disk.style.backgroundImage = `url('${DEFAULT_DISK_IMAGE}')`; resolve(); };
        img.src = imageUrl;
      });
    }

    function loadSong(index) {
      const song = playlist[index];
      if (!song) return;
      audio.src = song.src;
      highlightCurrentSong();
      return setDiskImage(song.diskImage);
    }

    function updatePlayPauseIcon() { playPauseIcon.src = isPlaying ? "ps_player_images/icons/pause.png" : "ps_player_images/icons/play.png"; }
    function playSong() { audio.play(); isPlaying = true; disk.classList.add("rotating"); updatePlayPauseIcon(); }
    function pauseSong() { audio.pause(); isPlaying = false; disk.classList.remove("rotating"); updatePlayPauseIcon(); }

    async function transitionToNextSong(nextIndex) {
      pauseSong();
      layer2.classList.remove("slide-reset"); layer2.classList.add("slide-down");
      await wait(400);
      layer4.classList.remove("slide-reset"); layer4.classList.add("slide-down");
      disk.classList.remove("slide-reset"); disk.classList.add("slide-down");
      await wait(600);
      currentSong = nextIndex;
      await loadSong(currentSong);
      disk.classList.remove("slide-down"); layer4.classList.remove("slide-down");
      disk.classList.add("slide-up"); layer4.classList.add("slide-up");
      await wait(50);
      disk.classList.remove("slide-up"); layer4.classList.remove("slide-up");
      disk.classList.add("slide-reset"); layer4.classList.add("slide-reset");
      await wait(600);
      layer2.classList.remove("slide-down"); layer2.classList.add("slide-reset");
      await wait(400);
      playSong();
    }

    function prevSong() { transitionToNextSong((currentSong - 1 + playlist.length) % playlist.length); }
    function nextSong() {
      if (!playlist.length) return;
      let nextIndex = isShuffling ? Math.floor(Math.random() * playlist.length) : (currentSong + 1) % playlist.length;
      if (isShuffling && nextIndex === currentSong) nextIndex = (currentSong + 1) % playlist.length;
      transitionToNextSong(nextIndex);
    }

    playPauseBtn.addEventListener("click", () => isPlaying ? pauseSong() : playSong());
    volumeSlider.addEventListener("input", e => audio.volume = e.target.value);
    volUpBtn.addEventListener("click", () => { audio.volume = Math.min(audio.volume + 0.1, 1); volumeSlider.value = audio.volume; });
    volDownBtn.addEventListener("click", () => { audio.volume = Math.max(audio.volume - 0.1, 0); volumeSlider.value = audio.volume; });
    muteBtn.addEventListener("click", () => { audio.muted = !audio.muted; muteIcon.src = audio.muted ? "ps_player_images/icons/mute.png" : "ps_player_images/icons/volume_up.png"; });
    shuffleBtn.addEventListener("click", () => { isShuffling = !isShuffling; shuffleBtn.classList.toggle("active", isShuffling); });
    prevBtn.addEventListener("click", prevSong);
    nextBtn.addEventListener("click", nextSong);
    audio.addEventListener("ended", nextSong);
    searchBox.addEventListener("input", e => filterMusicList(e.target.value));
    fetchPlaylistFromFolder();
  </script>
</body>
</html>
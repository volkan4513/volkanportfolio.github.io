<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Image Song Player with List</title>
    <style>
        :root {
            --bg-color: #111;
            --btn-bg: #222;
            --btn-hover: #444;
            --accent-color: #0a0;
            --text-color: #fff;
        }

        html {
            /* This is the core of the scaling. 
    1.6% of the *smallest* viewport dimension (width or height).
    All 'rem' units below will be based on this.
  */
            font-size: 1.6vmin;
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: system-ui, sans-serif;
            margin: 0;

            /* 1. Use Grid for the layout */
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* Two equal columns */
            grid-template-rows: 1fr;
            /* One row filling all height */

            /* 2. Force layout into viewport with no scrollbars */
            height: 100vh;
            overflow: hidden;

            /* 3. Use 'rem' (based on vmin) for scalable gaps */
            gap: 1.5rem;
            padding: 1.5rem;
        }

        /* LEFT: PLAYER */
        .player-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
            /* Scroll player controls if window is tiny */
            min-width: 0;
            /* Allow grid cell to shrink */
            min-height: 0;
        }

        /* Right: MUSIC LIST */
        .list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            /* 10px / 16 = 0.625rem */
            min-width: 0;
            /* Allow grid cell to shrink */
            min-height: 0;
            overflow-y: auto;
            /* This is the ONLY allowed scrollbar */
        }

        #searchBox {
            padding: 0.5rem;
            /* 8px */
            border-radius: 0.5rem;
            /* 8px */
            border: 0.125rem solid var(--text-color);
            /* 2px */
            background: var(--btn-bg);
            color: var(--text-color);
            font-size: 1rem;
            /* Scale with vmin */
        }

        ul#musicList {
            padding: 0;
            margin: 0;
        }

        ul#musicList li {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            /* 10px */
            padding: 0.375rem 0.625rem;
            /* 6px 10px */
            cursor: pointer;
            border-radius: 0.5rem;
            /* 8px */
            transition: background 0.2s;
            font-size: 0.9rem;
            /* Scale with vmin */
        }

        ul#musicList li img {
            width: 3.125rem;
            /* 50px */
            height: 3.125rem;
            /* 50px */
            object-fit: cover;
            border-radius: 0.5rem;
            /* 8px */
        }

        ul#musicList li:hover,
        ul#musicList li.active {
            background: var(--accent-color);
            color: #000;
        }


        /* CONTAINER (COVER & DISK) */
        .container {
            position: relative;
            /* Use width 100% of its container, but cap it */
            width: 100%;
            max-width: 37.5rem;
            /* 600px */
            aspect-ratio: 1 / 1;
            border-radius: 1.25rem;
            /* 20px */
            overflow: hidden;
            margin-bottom: 1.5rem;
            /* 2rem was too much, 1.5rem is good */
            transform-origin: center center;
            margin-left: auto;
            margin-right: auto;
        }

        .layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 1.25rem;
            /* 20px */
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.6s ease-in-out, opacity 0.4s ease;
        }

        /* Layers */
        #layer1 {
            background-image: url('ps_player_images/ps_front_cover.webp');
            z-index: 5;
        }

        #layer2 {
            background-image: url('ps_player_images/ps_disk_cover.webp');
            z-index: 4;
        }

        #disk {
            background-image: url('ps_player_images/ps_default_disk_00.webp');
            z-index: 3;
        }

        #layer4 {
            background-image: url('ps_player_images/ps_empty_disk.webp');
            z-index: 2;
        }

        #layer5 {
            background-image: url('ps_player_images/ps_disk_back.webp');
            z-index: 1;
        }

        /* CONTROLS */
        .controls,
        .volume-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        button {
            background: var(--btn-bg);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            /* Scalable buttons */
            width: 3.75rem;
            /* 60px */
            height: 3.75rem;
            /* 60px */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem;
            /* 6px */
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.3);
            /* 0 4px 8px */
        }

        button:hover {
            background: var(--btn-hover);
            transform: scale(1.1);
            box-shadow: 0 0.375rem 0.75rem rgba(0, 0, 0, 0.4);
            /* 0 6px 12px */
        }

        button:active {
            transform: scale(1.0);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
            /* 0 2px 4px */
        }

        button img {
            width: 60%;
            height: 60%;
            object-fit: contain;
            pointer-events: none;
        }

        .volume-controls input[type="range"] {
            width: 10rem;
            /* 160px */
            accent-color: var(--accent-color);
        }

        /* Rotation animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .rotating {
            animation: spin 6s linear infinite;
        }

        /* Slide transitions */
        .slide-down {
            transform: translateY(120%);
            opacity: 0;
        }

        .slide-up {
            transform: translateY(-120%);
            opacity: 0;
        }

        .slide-reset {
            transform: translateY(0);
            opacity: 1;
        }

        /* Shuffle active state */
        #shuffleBtn.active {
            background: var(--accent-color);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3), inset 0 0 0.625rem rgba(0, 0, 0, 0.5);
            /* 0 2px 4px, inset 0 0 10px */
        }

        /* Responsive */
        @media (max-width: 900px) {

            /* On mobile, change grid to a single column */
            body {
                grid-template-columns: 1fr;
                /* Single column */
                grid-template-rows: auto 1fr;
                /* Player on top (auto size), List on bottom (fills rest) */
                height: 100vh;
                /* Force to viewport height */
                padding: 1rem;
                gap: 1rem;
            }

            html {
                /* Make text slightly larger on mobile screens */
                font-size: 2vmin;
            }

            .container {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>

<body>

    <div class="player-container">
          <div class="container">
                <div id="layer1" class="layer"></div>
                <div id="layer2" class="layer"></div>
                <div id="disk" class="layer"></div>
                <div id="layer4" class="layer"></div>
                <div id="layer5" class="layer"></div>
              </div>

            <div class="controls">
                <button id="shuffleBtn" title="Shuffle"><img src="ps_player_images/icons/shuffle.png"
                    alt="Shuffle"></button>
                <button id="prevBtn" title="Previous"><img src="ps_player_images/icons/prev.png"
                    alt="Previous"></button>
                <button id="playPauseBtn" title="Play/Pause"><img src="ps_player_images/icons/play.png" alt="Play"
                    id="playPauseIcon"></button>
                <button id="nextBtn" title="Next"><img src="ps_player_images/icons/next.png" alt="Next"></button>
                <button id="muteBtn" title="Mute"><img src="ps_player_images/icons/volume_up.png" alt="Mute"
                    id="muteIcon"></button>
              </div>

          <div class="volume-controls">
                <button id="volDownBtn" title="Volume Down"><img src="ps_player_images/icons/volume_down.png"
                    alt="Volume Down"></button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
                <button id="volUpBtn" title="Volume Up"><img src="ps_player_images/icons/volume_up.png"
                    alt="Volume Up"></button>
              </div>
    </div>

    <div classs="list-container">
          <input type="text" id="searchBox" placeholder="Search...">
          <ul id="musicList"></ul>
    </div>

    <audio id="audio"></audio>

    <script>
        const audio = document.getElementById("audio");
        const playPauseBtn = document.getElementById("playPauseBtn");
        const playPauseIcon = document.getElementById("playPauseIcon");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const shuffleBtn = document.getElementById("shuffleBtn");
        const muteBtn = document.getElementById("muteBtn");
        const muteIcon = document.getElementById("muteIcon");
        const volumeSlider = document.getElementById("volumeSlider");
        const volUpBtn = document.getElementById("volUpBtn");
        const volDownBtn = document.getElementById("volDownBtn");

        const layer2 = document.getElementById("layer2");
        const layer4 = document.getElementById("layer4");
        const disk = document.getElementById("disk");

        const musicListElement = document.getElementById("musicList");
        const searchBox = document.getElementById("searchBox");

        const DEFAULT_DISK_IMAGE = "ps_player_images/ps_default_disk_00.webp";
        let playlist = [];
        let currentSong = 0;
        let isPlaying = false;
        let isShuffling = false;

        const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

        // Fetch playlist from folder
        async function fetchPlaylistFromFolder() {
            try {
                const res = await fetch("/music/");
                const text = await res.text();
                const matches = [...text.matchAll(/href="([^"]+\.(mp3|ogg|wav))"/gi)];
                const files = matches.map(m => decodeURIComponent(m[1])).filter(f => !f.startsWith("cover/"));

                playlist = files.map(filename => {
                    const base = filename.replace(/\.[^/.]+$/, "");
                    return { src: `music/${filename}`, diskImage: `music/cover/${base}.webp`, name: base };
                });

                if (!playlist.length) return console.warn("No songs found.");

                buildMusicList();
                await loadSong(currentSong);
            } catch (err) { console.error("Could not load music folder:", err); }
        }

        // Build clickable music list
        function buildMusicList() {
            musicListElement.innerHTML = "";
            playlist.forEach((song, index) => {
                const li = document.createElement("li");

                const img = document.createElement("img");
                img.src = song.diskImage; // show song cover
                img.onerror = () => { img.src = DEFAULT_DISK_IMAGE }; // fallback

                const span = document.createElement("span");
                span.textContent = song.name.replace(/_/g, " ");

                li.appendChild(img);
                li.appendChild(span);

                li.addEventListener("click", () => {
                    currentSong = index;
                    transitionToNextSong(currentSong);
                });

                musicListElement.appendChild(li);
            });
            highlightCurrentSong();
        }


        // Highlight active song
        function highlightCurrentSong() {
            Array.from(musicListElement.children).forEach((li, idx) => {
                li.classList.toggle("active", idx === currentSong);
            });
        }

        function filterMusicList(query) {
            Array.from(musicListElement.children).forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(query.toLowerCase()) ? "" : "none";
            });
        }

        // Disk image
        function setDiskImage(imageUrl) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => { disk.style.backgroundImage = `url('${imageUrl}')`; resolve(); };
                img.onerror = () => { disk.style.backgroundImage = `url('${DEFAULT_DISK_IMAGE}')`; resolve(); };
                img.src = imageUrl;
            });
        }

        // Load song
        function loadSong(index) {
            const song = playlist[index];
            if (!song) return;
            audio.src = song.src;
            highlightCurrentSong();
            return setDiskImage(song.diskImage);
        }

        // Play/Pause
        function updatePlayPauseIcon() { playPauseIcon.src = isPlaying ? "ps_player_images/icons/pause.png" : "ps_player_images/icons/play.png"; }
        function playSong() { audio.play(); isPlaying = true; disk.classList.add("rotating"); updatePlayPauseIcon(); }
        function pauseSong() { audio.pause(); isPlaying = false; disk.classList.remove("rotating"); updatePlayPauseIcon(); }

        async function transitionToNextSong(nextIndex) {
            pauseSong();
            layer2.classList.remove("slide-reset"); layer2.classList.add("slide-down");
            await wait(400);
            layer4.classList.remove("slide-reset"); layer4.classList.add("slide-down");
            disk.classList.remove("slide-reset"); disk.classList.add("slide-down");
            await wait(600);

            currentSong = nextIndex;
            await loadSong(currentSong);

            disk.classList.remove("slide-down"); layer4.classList.remove("slide-down");
            disk.classList.add("slide-up"); layer4.classList.add("slide-up");
            await wait(50);
            disk.classList.remove("slide-up"); layer4.classList.remove("slide-up");
            disk.classList.add("slide-reset"); layer4.classList.add("slide-reset");
            await wait(600);
            layer2.classList.remove("slide-down"); layer2.classList.add("slide-reset");
            await wait(400);

            playSong();
        }

        function prevSong() { transitionToNextSong((currentSong - 1 + playlist.length) % playlist.length); }
        function nextSong() {
// Next song
            if (!playlist.length) return;
            let nextIndex = isShuffling ? Math.floor(Math.random() * playlist.length) : (currentSong + 1) % playlist.length;
            if (isShuffling && nextIndex === currentSong) nextIndex = (currentSong + 1) % playlist.length;
            transitionToNextSong(nextIndex);
        }

        // Controls
        playPauseBtn.addEventListener("click", () => isPlaying ? pauseSong() : playSong());
        volumeSlider.addEventListener("input", e => audio.volume = e.target.value);
        volUpBtn.addEventListener("click", () => { audio.volume = Math.min(audio.volume + 0.1, 1); volumeSlider.value = audio.volume; });
        volDownBtn.addEventListener("click", () => { audio.volume = Math.max(audio.volume - 0.1, 0); volumeSlider.value = audio.volume; });
        muteBtn.addEventListener("click", () => { audio.muted = !audio.muted; muteIcon.src = audio.muted ? "ps_player_images/icons/mute.png" : "ps_player_images/icons/volume_up.png"; });
        shuffleBtn.addEventListener("click", () => { isShuffling = !isShuffling; shuffleBtn.classList.toggle("active", isShuffling); });
        prevBtn.addEventListener("click", prevSong);
        nextBtn.addEventListener("click", nextSong);
        audio.addEventListener("ended", nextSong);

        // Search
        searchBox.addEventListener("input", e => filterMusicList(e.target.value));

        // Initialize
        fetchPlaylistFromFolder();
    </script>
</body>

</html>